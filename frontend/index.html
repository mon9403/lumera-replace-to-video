<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lumera AI ‚Äì Image ‚ûú Kling Video</title>
  <style>
    body{font-family:ui-sans-serif,system-ui,Arial;padding:24px;max-width:960px;margin:auto}
    h1{font-size:22px;margin-bottom:8px}
    .card{border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea,button{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
    button{cursor:pointer;font-weight:700}
    #status{white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace}
    img,video{max-width:100%;border-radius:12px}
    .mono{font-family:ui-monospace,Menlo,monospace}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .prompt-box {
  max-height: 180px;       /* show ~6‚Äì8 lines */
  overflow-y: auto;        /* vertical scroll if longer */
  padding: 10px;
  background: #f9fafb;     /* subtle gray background */
  border-radius: 8px;
  white-space: pre-wrap;   /* keep line breaks, wrap long lines */
}
  </style>
</head>
<body>
  <h1>üéûÔ∏è Lumera AI ‚Äì Image ‚ûú Kling Video</h1>
  <p>Upload a <b>reference image</b>. We‚Äôll analyze it (subject/environment/mood), build a cinematic <b>Kling prompt</b>, and render a short video.</p>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Reference image</label>
        <input type="file" id="reference" accept="image/*" />
      </div>
      <div class="col">
        <label>Aspect ratio</label>
        <select id="aspect">
          <option value="9:16" selected>9:16 (vertical)</option>
          <option value="1:1">1:1</option>
          <option value="16:9">16:9 (landscape)</option>
        </select>
      </div>
      <div class="col">
        <label>Duration (seconds)</label>
        <input type="number" id="duration" min="5" max="10" value="5" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Extra creative direction (optional)</label>
        <textarea id="notes" rows="3" placeholder="e.g., luxury, golden haze, subtle orbit around bottle..."></textarea>
      </div>
    </div>
    <div class="row actions">
      <button id="go">Generate</button>
      <button id="share" disabled>Make share link</button>
      <input id="shareUrl" readonly placeholder="Share URL will appear here" />
    </div>
  </div>

<div class="card">
  <h3>üé¨ Kling Prompt</h3>
  <pre id="prompt" class="mono prompt-box"></pre>
  <button id="copyPrompt">Copy</button>
</div>

  <div class="card">
    <h3>üì° Status</h3>
    <div id="status">Idle.</div>
  </div>

  <div class="card">
    <h3>üì∫ Final Video</h3>
    <video id="video" controls playsinline></video>
  </div>

  <script>
    const apiBase = location.origin; // keep same-origin to avoid mismatch
    const el = (id) => document.getElementById(id);

    let lastTaskId = null;
    let lastImageUrl = null;
    let lastPrompt = null;

    const q = new URLSearchParams(location.search);
    const LS_KEY = "lumera:lastTask";

    function saveTaskState(state){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function loadTaskState(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; }
    }
    function clearTaskState(){
      localStorage.removeItem(LS_KEY);
    }
    function setUrlTaskParam(taskId){
      const url = new URL(location.href);
      url.searchParams.set("task", taskId);
      history.replaceState(null, "", url.toString());
    }

    async function compose() {
      const reference = el('reference').files[0];
      const aspect = el('aspect').value;
      const duration = el('duration').value;
      const notes = el('notes').value;

      if (!reference) {
        alert('Please choose a reference image.');
        return;
      }

      const fd = new FormData();
      fd.append('reference', reference);
      fd.append('aspect', aspect);
      fd.append('duration', duration);
      if (notes) fd.append('notes', notes);

      el('status').textContent = 'Uploading & drafting prompt...';

      const r = await fetch(`${apiBase}/api/compose`, { method: 'POST', body: fd });
      if (!r.ok) {
        const t = await r.text();
        throw new Error('Compose failed: ' + t);
      }
      const data = await r.json();
      console.log('compose ->', data);

      el('prompt').textContent = data.prompt;
      lastTaskId = data.task_id;
      lastImageUrl = data.composite_url; // now the reference image URL
      lastPrompt = data.prompt;
      
      saveTaskState({ task_id: lastTaskId, image_url: lastImageUrl, prompt: lastPrompt });
      setUrlTaskParam(lastTaskId);

      el('share').disabled = false;

      if (data.task_id) {
        pollTask(data.task_id);
      } else {
        el('status').textContent = 'No task_id returned.';
      }
    }

    async function pollTask(taskId) {
      let tries = 0;
      let delay = 2000; const maxDelay = 15000;
      const started = Date.now();

      function fmt(ms){const s=Math.floor(ms/1000),m=Math.floor(s/60),r=s%60;return m?`${m}m ${r}s`:`${s}s`; }

      const tick = async () => {
        tries++;
        const r = await fetch(`${apiBase}/api/task/${taskId}`);
        if (!r.ok) {
          const t = await r.text();
          el('status').textContent = 'Task error: ' + t;
          return;
        }
        const data = await r.json();
        const s = (data.status || 'unknown').toLowerCase();
        el('status').textContent = `Status: ${s.toUpperCase()} ‚Ä¢ ${fmt(Date.now()-started)} ‚Ä¢ try ${tries}`;

        if (s === 'completed' && data.video_url) {
          el('video').src = data.video_url;
          el('status').textContent = '‚úÖ Completed.';
          clearTaskState();

          return;
        }
        if (s === 'failed') {
          el('status').textContent = '‚ùå Failed: ' + (data.detail || '');
          clearTaskState();
          return;
        }
        setTimeout(tick, delay);
        delay = Math.min(maxDelay, Math.round(delay*1.4));
      };
      tick();
    }

    async function makeShareLink() {
      if (!lastImageUrl || !lastTaskId) {
        alert('Run a generation first.');
        return;
      }
      const payload = { task_id: lastTaskId, composite_url: lastImageUrl, prompt: lastPrompt };
      const r = await fetch(`${apiBase}/api/share`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!r.ok) {
        alert('Share failed: ' + (data.detail || r.statusText));
        return;
      }
      document.getElementById('shareUrl').value = data.url;
    }

    window.addEventListener("DOMContentLoaded", async () => {
  // Prefer URL param, else localStorage
        const urlTask = q.get("task");
        const saved = loadTaskState();

        if (urlTask || saved?.task_id) {
          const taskId = urlTask || saved.task_id;
          lastTaskId   = taskId;
          lastImageUrl = saved?.image_url || "";
          lastPrompt   = saved?.prompt || "";

          if (lastPrompt) document.getElementById('prompt').textContent = lastPrompt;
          if (saved?.image_url) {
            // (optional) show the reference image somewhere if you want
          }

          document.getElementById('share').disabled = false;
          // resume polling
          pollTask(taskId);
        }
  });
    document.getElementById('copyPrompt').addEventListener('click', () => {
  navigator.clipboard.writeText(document.getElementById('prompt').textContent);
  alert('Prompt copied to clipboard!');
});

    document.getElementById('go').addEventListener('click', () => {
      compose().catch(err => {
        console.error(err);
        document.getElementById('status').textContent = 'Error: ' + err.message;
      });
    });
    document.getElementById('share').addEventListener('click', makeShareLink);
  </script>
</body>
</html>